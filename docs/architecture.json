{
  "project": "BTC-Bot",
  "version": "v2.26.3",
  "updated": "2026-02-19",
  "description": "Big Truckin' Crypto Bot - Autonomous trading platform with multi-strategy support, AI-powered analysis, and real-time monitoring",

  "stack": {
    "backend": {
      "framework": "FastAPI",
      "orm": "SQLAlchemy (async)",
      "database": "SQLite (aiosqlite)",
      "python": "3.x (venv)",
      "auth": "JWT (python-jose) + TOTP MFA (pyotp) + Email MFA",
      "encryption": "Fernet (cryptography)",
      "email": "AWS SES (boto3, IAM role auth)"
    },
    "frontend": {
      "framework": "React 18",
      "language": "TypeScript",
      "bundler": "Vite",
      "styling": "TailwindCSS",
      "state": "React Context + React Query",
      "charts": "Lightweight Charts (TradingView)",
      "http": "Axios",
      "routing": "react-router-dom"
    },
    "deployment": {
      "platform": "AWS EC2 (Amazon Linux 2023)",
      "process_manager": "systemd",
      "services": ["trading-bot-backend", "trading-bot-frontend (dev mode only)", "nginx"],
      "reverse_proxy": "Nginx with Let's Encrypt SSL",
      "public_url": "https://tradebot.romerotechsolutions.com",
      "frontend_serving": "PROD mode: built dist/ served by FastAPI backend behind Nginx. DEV mode: Vite dev server with HMR."
    }
  },

  "backend": {
    "routers": [
      { "file": "routers/account_router.py", "prefix": "/api/account", "purpose": "Account balances, aggregate value, portfolio operations" },
      { "file": "routers/account_value_router.py", "prefix": "/api/account-value", "purpose": "Historical account value snapshots for charting" },
      { "file": "routers/accounts_router.py", "prefix": "/api/accounts", "purpose": "CRUD for CEX and DEX trading accounts" },
      { "file": "routers/ai_credentials_router.py", "prefix": "/api/ai-credentials", "purpose": "Manage per-user AI provider API keys" },
      { "file": "routers/auth_router.py", "prefix": "/api/auth", "purpose": "Login (with MFA), signup, token refresh, password change, TOTP MFA setup/verify/disable, email MFA, trusted devices, email verification, password reset" },
      { "file": "routers/blacklist_router.py", "prefix": "/api/blacklist", "purpose": "Coin blacklist and category management" },
      { "file": "routers/bots.py", "prefix": "/api/bots", "purpose": "Aggregator for bot sub-routers (CRUD, control, logs, validation)" },
      { "file": "routers/coin_icons_router.py", "prefix": "/api/coin-icons", "purpose": "Proxy and cache cryptocurrency icons to avoid CORS" },
      { "file": "routers/market_data_router.py", "prefix": "/api", "purpose": "Current prices, OHLCV candles (cached), product listings" },
      { "file": "routers/news_router.py", "prefix": "/api/news", "purpose": "Aggregated crypto news, video feeds, article content, source management" },
      { "file": "routers/news_metrics_router.py", "prefix": "/api/news", "purpose": "Market sentiment & blockchain metrics endpoints (Fear & Greed, BTC dominance, etc.)" },
      { "file": "routers/news_tts_router.py", "prefix": "/api/news", "purpose": "Text-to-speech generation, audio caching, voice subscriptions" },
      { "file": "routers/order_history.py", "prefix": "/api/order-history", "purpose": "Successful and failed order history with filtering" },
      { "file": "routers/paper_trading_router.py", "prefix": "/api/paper-trading", "purpose": "Virtual paper trading account management" },
      { "file": "routers/positions_router.py", "prefix": "/api/positions", "purpose": "Aggregator for position sub-routers (queries, actions, limit orders, manual ops, perps)" },
      { "file": "routers/seasonality_router.py", "prefix": "/api/seasonality", "purpose": "Market seasonality toggle for automatic bot management" },
      { "file": "routers/settings_router.py", "prefix": "/api", "purpose": "User settings, changelog, system configuration" },
      { "file": "routers/sources_router.py", "prefix": "/api/sources", "purpose": "News and video source subscription management" },
      { "file": "routers/strategies_router.py", "prefix": "/api/strategies", "purpose": "Available trading strategies and parameter definitions" },
      { "file": "routers/system_router.py", "prefix": "/api", "purpose": "Health check, dashboard stats, monitor control, system status" },
      { "file": "routers/templates.py", "prefix": "/api/templates", "purpose": "Bot template CRUD" },
      { "file": "routers/trading_router.py", "prefix": "/api/trading", "purpose": "Manual buy/sell orders for portfolio management" },
      { "file": "routers/prop_guard_router.py", "prefix": "/api/propguard", "purpose": "PropGuard safety monitoring: status, kill switch, reset, history" }
    ],

    "sub_routers": {
      "bot_routers": [
        { "file": "bot_routers/bot_crud_router.py", "purpose": "Bot creation, reading, updating, deletion, strategy listing" },
        { "file": "bot_routers/bot_control_router.py", "purpose": "Bot activation, deactivation, and force-run operations" },
        { "file": "bot_routers/bot_ai_logs_router.py", "purpose": "AI bot reasoning/thinking log retrieval" },
        { "file": "bot_routers/bot_indicator_logs_router.py", "purpose": "Indicator condition evaluation log retrieval" },
        { "file": "bot_routers/bot_scanner_logs_router.py", "purpose": "Scanner/monitor log retrieval for non-AI strategies" },
        { "file": "bot_routers/bot_validation_router.py", "purpose": "Bot config validation against exchange minimums" },
        { "file": "bot_routers/schemas.py", "purpose": "Pydantic request/response schemas for bot routes" }
      ],
      "position_routers": [
        { "file": "position_routers/position_query_router.py", "purpose": "Position listing, details, trades, AI logs, P&L timeseries" },
        { "file": "position_routers/position_actions_router.py", "purpose": "Cancel, force-close, and update position settings" },
        { "file": "position_routers/position_limit_orders_router.py", "purpose": "Limit order operations (create, cancel, slippage check)" },
        { "file": "position_routers/position_manual_ops_router.py", "purpose": "Manual operations: add funds, update notes" },
        { "file": "position_routers/perps_router.py", "purpose": "Perpetual futures (INTX) position endpoints" },
        { "file": "position_routers/dependencies.py", "purpose": "Shared dependency functions for position routes" },
        { "file": "position_routers/schemas.py", "purpose": "Pydantic request/response schemas for position routes" }
      ],
      "news_data_modules": [
        { "file": "news_data/news_sources.py", "purpose": "News and video source configurations by category" },
        { "file": "news_data/news_cache.py", "purpose": "Cache loading/saving for news and video data" },
        { "file": "news_data/news_models.py", "purpose": "Pydantic models for news router API" },
        { "file": "news_data/debt_ceiling_data.py", "purpose": "Historical US debt ceiling data (1939-present)" }
      ]
    },

    "models": [
      { "name": "User", "table": "users", "key_fields": ["id", "email", "hashed_password", "is_active", "mfa_enabled", "totp_secret", "terms_accepted", "email_verified"] },
      { "name": "TrustedDevice", "table": "trusted_devices", "key_fields": ["id", "user_id", "device_id", "device_name", "ip_address", "location", "expires_at"] },
      { "name": "EmailVerificationToken", "table": "email_verification_tokens", "key_fields": ["id", "user_id", "token", "expires_at", "used"] },
      { "name": "RevokedToken", "table": "revoked_tokens", "key_fields": ["id", "jti", "user_id", "expires_at"], "purpose": "Revoked JWT tokens for server-side token invalidation on logout and password change" },
      { "name": "Account", "table": "accounts", "key_fields": ["id", "user_id", "name", "exchange", "account_type", "api_key", "api_secret", "is_default"] },
      { "name": "Bot", "table": "bots", "key_fields": ["id", "account_id", "name", "strategy", "status", "trading_pairs", "budget_percentage", "max_concurrent_deals"] },
      { "name": "BotTemplate", "table": "bot_templates", "key_fields": ["id", "user_id", "name", "strategy", "config_json"] },
      { "name": "Position", "table": "positions", "key_fields": ["id", "bot_id", "product_id", "status", "side", "total_base_acquired", "total_quote_spent", "average_buy_price"] },
      { "name": "Trade", "table": "trades", "key_fields": ["id", "position_id", "trade_type", "price", "amount", "quote_amount"] },
      { "name": "Signal", "table": "signals", "key_fields": ["id", "product_id", "signal_type", "price", "indicator_values"] },
      { "name": "Settings", "table": "settings", "key_fields": ["id", "user_id", "key", "value"] },
      { "name": "MarketData", "table": "market_data", "key_fields": ["id", "product_id", "timestamp", "price", "volume"] },
      { "name": "AIBotLog", "table": "ai_bot_logs", "key_fields": ["id", "bot_id", "product_id", "decision", "confidence", "thinking", "context"] },
      { "name": "ScannerLog", "table": "scanner_logs", "key_fields": ["id", "bot_id", "product_id", "decision", "metrics"] },
      { "name": "IndicatorLog", "table": "indicator_logs", "key_fields": ["id", "bot_id", "product_id", "phase", "conditions_met", "details"] },
      { "name": "PendingOrder", "table": "pending_orders", "key_fields": ["id", "position_id", "order_id", "order_type", "side", "price", "size", "status"] },
      { "name": "OrderHistory", "table": "order_history", "key_fields": ["id", "user_id", "bot_id", "product_id", "side", "status", "order_type"] },
      { "name": "BlacklistedCoin", "table": "blacklisted_coins", "key_fields": ["id", "symbol", "reason", "category"] },
      { "name": "AIProviderCredential", "table": "ai_provider_credentials", "key_fields": ["id", "user_id", "provider", "api_key_encrypted", "is_active"] },
      { "name": "BotProduct", "table": "bot_products", "key_fields": ["id", "bot_id", "product_id", "created_at"], "purpose": "Junction table normalizing bot trading pairs (1NF)" },
      { "name": "BotTemplateProduct", "table": "bot_template_products", "key_fields": ["id", "template_id", "product_id", "created_at"], "purpose": "Junction table normalizing template trading pairs (1NF)" },
      { "name": "NewsArticle", "table": "news_articles", "key_fields": ["id", "title", "url", "source", "category", "published_at", "cached_thumbnail_path"] },
      { "name": "VideoArticle", "table": "video_articles", "key_fields": ["id", "title", "video_id", "channel_name", "category", "published_at"] },
      { "name": "ContentSource", "table": "content_sources", "key_fields": ["id", "source_key", "name", "source_type", "url", "category", "is_system", "user_id"] },
      { "name": "UserSourceSubscription", "table": "user_source_subscriptions", "key_fields": ["id", "user_id", "source_id", "is_subscribed"] },
      { "name": "ArticleTTS", "table": "article_tts", "key_fields": ["id", "article_url", "voice_id", "audio_data", "content_hash"], "purpose": "Cached TTS audio per article and voice, shared across users" },
      { "name": "UserVoiceSubscription", "table": "user_voice_subscriptions", "key_fields": ["id", "user_id", "voice_id", "is_subscribed"], "purpose": "Per-user TTS voice preferences" },
      { "name": "UserArticleTTSHistory", "table": "user_article_tts_history", "key_fields": ["id", "user_id", "article_url", "voice_id"], "purpose": "Per-user last-played voice per article for auto-resume" },
      { "name": "UserContentSeenStatus", "table": "user_content_seen_status", "key_fields": ["id", "user_id", "content_type", "content_id", "seen_at"], "purpose": "Tracks which articles/videos each user has seen" },
      { "name": "AccountValueSnapshot", "table": "account_value_snapshots", "key_fields": ["id", "account_id", "timestamp", "btc_value", "usd_value"] },
      { "name": "MetricSnapshot", "table": "metric_snapshots", "key_fields": ["id", "metric_type", "timestamp", "value_json"] },
      { "name": "PropFirmState", "table": "prop_firm_state", "key_fields": ["id", "account_id", "initial_deposit", "current_equity", "is_killed", "kill_reason"] },
      { "name": "PropFirmEquitySnapshot", "table": "prop_firm_equity_snapshots", "key_fields": ["id", "account_id", "equity", "daily_drawdown_pct", "total_drawdown_pct", "timestamp"] }
    ],

    "services": [
      { "file": "services/account_snapshot_service.py", "purpose": "Captures daily account value snapshots for historical charting", "type": "background" },
      { "file": "services/ai_credential_service.py", "purpose": "Per-user AI provider credential management and retrieval", "type": "infrastructure" },
      { "file": "services/ai_grid_optimizer.py", "purpose": "AI-powered grid parameter optimization", "type": "analysis" },
      { "file": "services/auto_buy_monitor.py", "purpose": "Auto-converts stablecoins to BTC when balances exceed minimums", "type": "background" },
      { "file": "services/brand_service.py", "purpose": "White-label branding configuration and customization", "type": "infrastructure" },
      { "file": "services/budget_calculator.py", "purpose": "Calculates available capital for bidirectional bots with reservations", "type": "trading" },
      { "file": "services/coin_review_service.py", "purpose": "Weekly AI-powered coin status review and categorization", "type": "analysis" },
      { "file": "services/content_refresh_service.py", "purpose": "Periodically fetches news and video content from configured sources", "type": "background" },
      { "file": "services/debt_ceiling_monitor.py", "purpose": "Weekly check for US debt ceiling legislation changes", "type": "background" },
      { "file": "services/delisted_pair_monitor.py", "purpose": "Daily sync of trading pairs; removes delisted pairs from bots", "type": "background" },
      { "file": "services/dex_wallet_service.py", "purpose": "Fetches wallet balances from blockchain networks (Ethereum, L2s)", "type": "exchange" },
      { "file": "services/domain_blacklist_service.py", "purpose": "Domain-level blocking for content sources that block our IP", "type": "infrastructure" },
      { "file": "services/email_service.py", "purpose": "AWS SES email sending for verification, password reset, MFA codes", "type": "infrastructure" },
      { "file": "services/exchange_service.py", "purpose": "Per-user, per-account exchange client instantiation with async locking and double-checked caching", "type": "exchange" },
      { "file": "services/grid_rotation_service.py", "purpose": "Periodic profit lock-in and grid refresh for winning positions", "type": "trading" },
      { "file": "services/grid_trading_service.py", "purpose": "Grid bot lifecycle: initialization, level management, order placement", "type": "trading" },
      { "file": "services/indicator_log_service.py", "purpose": "Logs indicator condition evaluations for non-AI bots", "type": "logging" },
      { "file": "services/limit_order_monitor.py", "purpose": "Monitors pending limit orders and updates positions on fill", "type": "background" },
      { "file": "services/news_fetch_service.py", "purpose": "Fetches individual article content from source URLs with robots.txt compliance", "type": "background" },
      { "file": "services/news_image_cache.py", "purpose": "Downloads and saves news thumbnails as WebP files to backend/news_images/", "type": "background" },
      { "file": "services/order_reconciliation_monitor.py", "purpose": "Detects and fixes positions with missing fill data; includes MissingOrderDetector", "type": "background" },
      { "file": "services/perps_monitor.py", "purpose": "Syncs perpetual futures positions with Coinbase INTX state", "type": "background" },
      { "file": "services/portfolio_conversion_service.py", "purpose": "Portfolio conversion with progress tracking", "type": "trading" },
      { "file": "services/portfolio_service.py", "purpose": "Portfolio aggregation and balance calculations", "type": "trading" },
      { "file": "services/prop_guard_monitor.py", "purpose": "Background equity monitoring for prop firm accounts every 30s", "type": "background" },
      { "file": "services/season_detector.py", "purpose": "Market season detection using halving cycles and multiple indicators", "type": "analysis" },
      { "file": "services/settings_service.py", "purpose": "User settings retrieval and persistence", "type": "infrastructure" },
      { "file": "services/shutdown_manager.py", "purpose": "Tracks in-flight operations for graceful shutdown", "type": "infrastructure" },
      { "file": "services/websocket_manager.py", "purpose": "WebSocket connection manager for real-time order fill notifications", "type": "infrastructure" }
    ],

    "trading_engine": {
      "coordinators": [
        { "file": "trading_engine_v2.py", "purpose": "Strategy-based trading engine coordinator; wraps all trading modules" },
        { "file": "trading_client.py", "purpose": "Quote-currency agnostic buy/sell wrapper; works with any ExchangeClient" },
        { "file": "multi_bot_monitor.py", "purpose": "Monitors prices for all active bots and dispatches strategy signals; parallel processing with Semaphore(5) and per-task contextvars for exchange isolation" },
        { "file": "order_validation.py", "purpose": "Ensures orders meet exchange minimum size requirements" },
        { "file": "precision.py", "purpose": "Precision handling for exchange API order sizes" },
        { "file": "product_precision.py", "purpose": "Per-product increment specifications from exchange APIs" }
      ],
      "modules": [
        { "file": "trading_engine/signal_processor.py", "purpose": "Signal processing and trading decision orchestration" },
        { "file": "trading_engine/buy_executor.py", "purpose": "Market and limit buy order execution" },
        { "file": "trading_engine/sell_executor.py", "purpose": "Market and limit sell order execution" },
        { "file": "trading_engine/perps_executor.py", "purpose": "Perpetual futures order execution with bracket TP/SL" },
        { "file": "trading_engine/position_manager.py", "purpose": "Position CRUD operations and lifecycle management" },
        { "file": "trading_engine/order_logger.py", "purpose": "Order logging, AI decision logging, audit trail" },
        { "file": "trading_engine/trailing_stops.py", "purpose": "Trailing stop loss and trailing take profit management" }
      ]
    },

    "exchange_clients": {
      "base": "exchange_clients/base.py (ExchangeClient ABC)",
      "implementations": [
        { "file": "exchange_clients/coinbase_adapter.py", "purpose": "Wraps CoinbaseClient to implement ExchangeClient interface" },
        { "file": "exchange_clients/paper_trading_client.py", "purpose": "Simulated exchange client for paper trading" },
        { "file": "exchange_clients/bybit_adapter.py", "purpose": "Wraps ByBitClient to implement ExchangeClient for ByBit V5 linear perps" },
        { "file": "exchange_clients/bybit_client.py", "purpose": "Low-level pybit HTTP wrapper with product ID translation and async" },
        { "file": "exchange_clients/bybit_ws.py", "purpose": "ByBit WebSocket manager for real-time position/order/wallet/ticker streams" },
        { "file": "exchange_clients/mt5_bridge_client.py", "purpose": "ExchangeClient for FTMO MT5 EA bridge via HTTP JSON" },
        { "file": "exchange_clients/prop_guard.py", "purpose": "PropGuard safety decorator wrapping any ExchangeClient with drawdown checks" },
        { "file": "exchange_clients/prop_guard_state.py", "purpose": "Pure helper functions for drawdown calculations and daily reset logic" },
        { "file": "exchange_clients/dex_client.py", "purpose": "DEX trading client for on-chain swaps" },
        { "file": "exchange_clients/dex_constants.py", "purpose": "DEX contract addresses, router ABIs, chain configs" }
      ],
      "factory": "exchange_clients/factory.py",
      "coinbase_modules": [
        { "file": "coinbase_api/auth.py", "purpose": "HMAC and CDP authentication for Coinbase API" },
        { "file": "coinbase_api/account_balance_api.py", "purpose": "Account balance and portfolio queries" },
        { "file": "coinbase_api/market_data_api.py", "purpose": "Prices, candles, product listings with single-flight caching" },
        { "file": "coinbase_api/order_api.py", "purpose": "Order placement, cancellation, and status" },
        { "file": "coinbase_api/perpetuals_api.py", "purpose": "Perpetual futures positions, portfolio, allocations" },
        { "file": "coinbase_api/public_market_data.py", "purpose": "Public (no-auth) market data endpoints for paper trading and fallback; includes PublicMarketDataClient" }
      ],
      "unified_client": "coinbase_unified_client.py (CoinbaseClient wrapper coordinating all API modules)"
    },

    "strategies": [
      { "file": "strategies/__init__.py", "class": "TradingStrategy (ABC), StrategyRegistry", "purpose": "Base strategy interface and registry for strategy discovery" },
      { "file": "strategies/grid_trading.py", "class": "GridTradingStrategy", "purpose": "DCA grid trading with limit orders at predetermined price levels" },
      { "file": "strategies/indicator_based.py", "class": "IndicatorBasedStrategy", "purpose": "Unified condition-based strategy with configurable indicators for entry/DCA/exit" },
      { "file": "strategies/spatial_arbitrage.py", "class": "SpatialArbitrageStrategy", "purpose": "Cross-exchange arbitrage exploiting price differences between venues" },
      { "file": "strategies/statistical_arbitrage.py", "class": "StatisticalArbitrageStrategy", "purpose": "Mean-reversion strategy based on price correlations between pairs" },
      { "file": "strategies/triangular_arbitrage.py", "class": "TriangularArbitrageStrategy", "purpose": "Single-exchange 3-currency cycle arbitrage (e.g., ETH->BTC->USDT->ETH)" },
      { "file": "strategies/bull_flag_scanner.py", "class": "N/A (utility)", "purpose": "Volume spike and bull flag pattern detection for USD pairs" },
      { "file": "strategies/condition_mirror.py", "class": "ConditionMirror", "purpose": "Mirrors long conditions to short conditions for bidirectional bots" }
    ],

    "core_modules": [
      { "file": "main.py", "purpose": "FastAPI application entry point, startup/shutdown events, background task orchestration" },
      { "file": "ai_service.py", "purpose": "Unified AI client interface (Anthropic, OpenAI, Google Gemini)" },
      { "file": "cache.py", "purpose": "In-memory cache with TTL, single-flight pattern (thundering herd prevention), and persistent portfolio cache" },
      { "file": "cleanup_jobs.py", "purpose": "Scheduled database cleanup for old decision logs, failed orders, noise logs" },
      { "file": "conditions.py", "purpose": "Flexible condition framework (3Commas-style) with indicator comparisons" },
      { "file": "config.py", "purpose": "Pydantic settings loaded from .env (database URL, JWT secret, CORS, etc.)" },
      { "file": "constants.py", "purpose": "Trading pairs, timeframes, and other application constants" },
      { "file": "currency_utils.py", "purpose": "Multi-quote-currency detection and formatting (BTC/USD)" },
      { "file": "database.py", "purpose": "SQLAlchemy async engine, session maker, default content sources" },
      { "file": "encryption.py", "purpose": "Fernet encryption for API keys and credentials at rest" },
      { "file": "indicator_calculator.py", "purpose": "Calculates all technical indicators from candle data for conditions" },
      { "file": "indicators.py", "purpose": "Technical indicator calculators (MACD, RSI, Bollinger Bands, EMA, SMA)" },
      { "file": "models.py", "purpose": "SQLAlchemy ORM model definitions for all database tables" },
      { "file": "phase_conditions.py", "purpose": "Advanced condition grouping with AND/OR/NOT logic (3Commas-style)" }
    ],

    "schemas": [
      { "file": "schemas/dashboard.py", "purpose": "Dashboard statistics Pydantic response models" },
      { "file": "schemas/market.py", "purpose": "Market data and signal Pydantic schemas" },
      { "file": "schemas/position.py", "purpose": "Position Pydantic response schemas" },
      { "file": "schemas/settings.py", "purpose": "Settings Pydantic schemas" }
    ],

    "indicators_module": [
      { "file": "indicators/ai_spot_opinion.py", "purpose": "AI-powered indicator combining technical metrics with LLM reasoning" },
      { "file": "indicators/bull_flag_indicator.py", "purpose": "Bull flag chart pattern detection aggregate indicator" },
      { "file": "indicators/risk_presets.py", "purpose": "Default risk preset configurations for AI indicators" }
    ],

    "price_feeds": [
      { "file": "price_feeds/base.py", "purpose": "Abstract PriceFeed interface" },
      { "file": "price_feeds/coinbase_feed.py", "purpose": "Coinbase exchange price feed implementation" },
      { "file": "price_feeds/dex_feed.py", "purpose": "DEX price feed implementation (Uniswap V3, etc.)" },
      { "file": "price_feeds/aggregator.py", "purpose": "Combines multiple price feeds for best-price discovery" }
    ],

    "middleware": [
      { "file": "middleware/datetime_timezone.py", "purpose": "Adds 'Z' suffix to datetime fields in JSON responses" }
    ],

    "utils": [
      { "file": "utils/candle_utils.py", "purpose": "Candle data utilities: timeframe aggregation, gap filling, synthetic timeframes" },
      { "file": "utils/robots_checker.py", "purpose": "Checks robots.txt compliance before scraping article content" },
      { "file": "utils/url_utils.py", "purpose": "URL normalization and validation utilities" }
    ],

    "external_integrations": {
      "ai_providers": [
        { "name": "Anthropic (Claude)", "library": "anthropic", "usage": "AI bot decisions, coin review, grid optimization" },
        { "name": "OpenAI (GPT)", "library": "openai", "usage": "Alternative AI provider for bot decisions" },
        { "name": "Google Gemini", "library": "google-generativeai", "usage": "Alternative AI provider for bot decisions" }
      ],
      "coinbase_api": {
        "type": "REST + WebSocket",
        "auth_methods": ["HMAC", "CDP (Cloud Developer Platform)"],
        "features": ["Spot trading", "Perpetual futures (INTX)", "Market data", "Account management"]
      },
      "bybit_api": {
        "type": "REST (pybit) + WebSocket (pybit)",
        "auth_methods": ["API Key + Secret (HMAC)"],
        "features": ["Linear perps trading", "Wallet balance", "Position management", "Real-time equity via WS"]
      },
      "mt5_bridge": {
        "type": "HTTP JSON (custom EA bridge)",
        "auth_methods": ["Bridge URL + Magic Number"],
        "features": ["Market/limit orders", "Position management", "Equity polling", "Emergency close-all"]
      },
      "dex": {
        "networks": ["Ethereum mainnet", "Arbitrum", "Polygon", "Base"],
        "features": ["Wallet balances", "Token holdings", "On-chain swaps"]
      },
      "news_feeds": {
        "types": ["RSS feeds", "Reddit JSON API", "YouTube Atom feeds"],
        "categories": ["CryptoCurrency", "AI", "Finance", "World", "Nation", "Business", "Technology", "Entertainment", "Sports"],
        "architecture_spec": "docs/NEWS_CONTENT_ARCHITECTURE.md",
        "notes": "See NEWS_CONTENT_ARCHITECTURE.md for full rules on system vs user sources, TTS sharing, retention, and visibility"
      },
      "market_data": {
        "sources": ["Fear & Greed Index", "BTC Dominance", "Altseason Index", "Market Cap", "Mempool", "Hash Rate", "Lightning Network"]
      },
      "email": {
        "provider": "AWS SES",
        "region": "us-east-1",
        "sender": "noreply@romerotechsolutions.com",
        "auth": "IAM role (ZenithGridEC2Role)",
        "features": ["Email verification", "Password reset", "MFA codes"]
      }
    },

    "background_tasks": [
      { "name": "MultiBotMonitor", "interval": "Per-strategy (15min for AI, varies for others)", "purpose": "Core bot loop: parallel price monitoring and strategy signal dispatch (Semaphore(5))" },
      { "name": "LimitOrderMonitor", "interval": "10 seconds", "purpose": "Check pending limit orders for fills" },
      { "name": "OrderReconciliationMonitor", "interval": "60 seconds", "purpose": "Auto-fix orphaned positions with missing fill data" },
      { "name": "MissingOrderDetector", "interval": "5 minutes", "purpose": "Detect unrecorded orders from exchange" },
      { "name": "TradingPairMonitor", "interval": "Daily (first check after 5min)", "purpose": "Sync trading pairs, remove delisted pairs from bots" },
      { "name": "ContentRefreshService", "interval": "News: 30min, Videos: 60min", "purpose": "Fetch fresh news articles and YouTube videos" },
      { "name": "DebtCeilingMonitor", "interval": "Weekly", "purpose": "Check for new US debt ceiling legislation" },
      { "name": "AutoBuyMonitor", "interval": "Per-account setting", "purpose": "Convert stablecoins to BTC when thresholds exceeded" },
      { "name": "PerpsMonitor", "interval": "60 seconds", "purpose": "Sync perpetual futures positions with exchange state" },
      { "name": "DecisionLogCleanup", "interval": "Daily", "purpose": "Remove old AI decision logs" },
      { "name": "FailedConditionCleanup", "interval": "6 hours", "purpose": "Remove noise indicator condition logs" },
      { "name": "FailedOrderCleanup", "interval": "6 hours", "purpose": "Remove old failed order records" },
      { "name": "AccountSnapshotCapture", "interval": "Daily (24 hours)", "purpose": "Capture account value snapshots for historical charts" }
    ],

    "migrations": {
      "count": 30,
      "naming_pattern": "snake_case descriptive names (e.g., add_account_value_snapshots.py)",
      "directory": "backend/migrations/",
      "discovery": "Auto-discovered by update.py",
      "idempotent": true,
      "files": [
        "add_account_value_snapshots.py",
        "add_article_content_cache.py",
        "add_article_content_fetch_failed.py",
        "add_article_has_issue.py",
        "add_article_source_id_fk.py",
        "add_bidirectional_support.py",
        "add_bot_name_unique_index.py",
        "add_content_scrape_policies.py",
        "add_content_source_user_id.py",
        "add_email_verification.py",
        "add_metric_snapshots_table.py",
        "add_mfa_email_method.py",
        "add_mfa_totp_support.py",
        "add_news_category_column.py",
        "add_paper_trading_accounts.py",
        "add_pending_order_reserves.py",
        "add_perpetual_futures_fields.py",
        "add_prop_firm_support.py",
        "add_subscription_category_retention.py",
        "add_tts_content_hash.py",
        "add_tts_tables.py",
        "add_user_content_seen_status.py",
        "bot_name_per_user_unique.py",
        "convert_coin_categories_to_global.py",
        "encrypt_existing_credentials.py",
        "extract_bot_products.py",
        "move_news_images_to_filesystem.py",
        "add_revoked_tokens.py",
        "remove_medicalxpress_source.py",
        "replace_paywalled_sources.py"
      ]
    }
  },

  "frontend": {
    "pages": [
      { "file": "pages/Dashboard.tsx", "route": "/", "purpose": "Bot list, open/closed positions summary, account value chart, profit metrics" },
      { "file": "pages/Bots.tsx", "route": "/bots", "purpose": "Create, edit, delete, and manage trading bots with strategy configuration" },
      { "file": "pages/Positions.tsx", "route": "/positions", "purpose": "Open positions with real-time P&L, limit close, edit settings, add funds" },
      { "file": "pages/ClosedPositions.tsx", "route": "/history", "purpose": "Closed and failed positions with trade history, AI logs, statistics" },
      { "file": "pages/Portfolio.tsx", "route": "/portfolio", "purpose": "All crypto holdings, balances by asset, sell coins, allocation charts" },
      { "file": "pages/News.tsx", "route": "/news", "purpose": "Aggregated news, video player, article reader with TTS, sentiment cards" },
      { "file": "pages/Charts.tsx", "route": "/charts", "purpose": "Technical analysis with multiple indicators, timeframes, chart types" },
      { "file": "pages/Settings.tsx", "route": "/settings", "purpose": "User settings, password, accounts, AI credentials, blacklist config" },
      { "file": "pages/Login.tsx", "route": "(auth page)", "purpose": "Email/password login and signup form" }
    ],

    "components": {
      "bot_management": [
        { "file": "components/ThreeCommasStyleForm.tsx", "purpose": "3Commas-style bot configuration form" },
        { "file": "components/ConditionalStrategyForm.tsx", "purpose": "Conditional/rule-based strategy configuration form" },
        { "file": "components/AdvancedConditionBuilder.tsx", "purpose": "Complex trading condition builder with logic gates" },
        { "file": "components/ConditionBuilder.tsx", "purpose": "Simple condition builder for strategy parameters" },
        { "file": "components/PhaseConditionSelector.tsx", "purpose": "Market phase condition selector (bull/bear/accumulation)" },
        { "file": "components/GridVisualizer.tsx", "purpose": "DCA grid level visualization" },
        { "file": "pages/bots/components/BotFormModal.tsx", "purpose": "Modal form for creating/editing bots" },
        { "file": "pages/bots/components/BotListItem.tsx", "purpose": "Bot card component for bot list" },
        { "file": "pages/bots/components/SampleBotsSection.tsx", "purpose": "Pre-configured sample bot templates for quick setup" },
        { "file": "pages/bots/data/sampleBots.ts", "purpose": "Sample bot template data definitions" },
        { "file": "pages/bots/helpers.ts", "purpose": "Bot page helper functions" }
      ],
      "position_management": [
        { "file": "components/EditPositionSettingsModal.tsx", "purpose": "Edit TP, SL, trailing TP, max safety orders" },
        { "file": "components/AddFundsModal.tsx", "purpose": "Add funds to existing positions" },
        { "file": "components/LimitCloseModal.tsx", "purpose": "Set limit close orders with price target" },
        { "file": "components/SlippageWarningModal.tsx", "purpose": "Slippage impact warning before market close" },
        { "file": "components/PositionLogsModal.tsx", "purpose": "View logs, trades, AI decisions for a position" },
        { "file": "pages/positions/components/FilterPanel.tsx", "purpose": "Filter controls for positions" },
        { "file": "pages/positions/components/OverallStatsPanel.tsx", "purpose": "Summary statistics for open positions" },
        { "file": "pages/positions/components/PerpsPortfolioPanel.tsx", "purpose": "Perpetual futures portfolio overview" },
        { "file": "pages/positions/components/PositionCard.tsx", "purpose": "Individual position display with P&L and actions" },
        { "file": "pages/positions/components/modals/CloseConfirmModal.tsx", "purpose": "Close position confirmation" },
        { "file": "pages/positions/components/modals/NotesModal.tsx", "purpose": "Position notes editor" },
        { "file": "pages/positions/components/modals/TradeHistoryModal.tsx", "purpose": "Trade history for a position" },
        { "file": "pages/positions/helpers.ts", "purpose": "Position page helper functions" }
      ],
      "charts": [
        { "file": "components/TradingChart.tsx", "purpose": "Lightweight price chart for position entry/exit" },
        { "file": "components/TradingViewChartModal.tsx", "purpose": "TradingView integration for technical analysis" },
        { "file": "components/LightweightChartModal.tsx", "purpose": "Full-featured chart modal with indicators and oscillators" },
        { "file": "components/DepthChart.tsx", "purpose": "Order book depth visualization" },
        { "file": "components/AccountValueChart.tsx", "purpose": "Account value over time line chart" },
        { "file": "components/PnLChart.tsx", "purpose": "P&L bar/line chart by time period" },
        { "file": "components/Sparkline.tsx", "purpose": "Minimal inline sparkline chart" },
        { "file": "components/charts/IndicatorSettingsModal.tsx", "purpose": "Indicator parameter configuration" },
        { "file": "pages/charts/helpers.ts", "purpose": "Charts page helper functions" }
      ],
      "logs_and_analysis": [
        { "file": "components/AIBotLogs.tsx", "purpose": "AI bot decision logs with filtering" },
        { "file": "components/ScannerLogs.tsx", "purpose": "Scanner logs for pair scanning decisions" },
        { "file": "components/IndicatorLogs.tsx", "purpose": "Indicator calculation logs with search" }
      ],
      "news_and_media": [
        { "file": "components/MiniPlayer.tsx", "purpose": "Persistent minimizable video player" },
        { "file": "components/ArticleReaderMiniPlayer.tsx", "purpose": "Persistent TTS article reader" },
        { "file": "pages/news/components/ArticleContent.tsx", "purpose": "Article content display" },
        { "file": "pages/news/components/TTSControls.tsx", "purpose": "Text-to-speech playback controls" },
        { "file": "components/news/SourceSubscriptionsModal.tsx", "purpose": "Subscribe/unsubscribe from news sources" },
        { "file": "pages/news/types.ts", "purpose": "TypeScript types for news page" },
        { "file": "pages/news/helpers.ts", "purpose": "News page helper functions" }
      ],
      "market_sentiment_cards": [
        { "file": "components/MarketSentimentCards.tsx", "purpose": "Card grid container for all sentiment indicators" },
        { "file": "components/cards/CardStates.tsx", "purpose": "Shared loading/error/empty states for cards" },
        { "file": "components/cards/InfoTooltip.tsx", "purpose": "Info tooltip component for card descriptions" },
        { "file": "components/cards/FearGreedCard.tsx", "purpose": "Fear & Greed Index card" },
        { "file": "components/cards/BTCDominanceCard.tsx", "purpose": "BTC dominance card" },
        { "file": "components/cards/AltseasonCard.tsx", "purpose": "Altseason Index card" },
        { "file": "components/cards/ATHCard.tsx", "purpose": "All-Time High distance card" },
        { "file": "components/cards/BTCRSICard.tsx", "purpose": "BTC RSI indicator card" },
        { "file": "components/cards/BTCSupplyCard.tsx", "purpose": "BTC supply metrics card" },
        { "file": "components/cards/HalvingCard.tsx", "purpose": "BTC halving countdown card" },
        { "file": "components/cards/SeasonCard.tsx", "purpose": "Market season indicator card" },
        { "file": "components/cards/USDebtCard.tsx", "purpose": "US debt ceiling card" },
        { "file": "components/cards/HashRateCard.tsx", "purpose": "Bitcoin hash rate card" },
        { "file": "components/cards/LightningCard.tsx", "purpose": "Lightning Network stats card" },
        { "file": "components/cards/MempoolCard.tsx", "purpose": "Bitcoin mempool stats card" },
        { "file": "components/cards/StablecoinMcapCard.tsx", "purpose": "Stablecoin market cap card" },
        { "file": "components/cards/TotalMarketCapCard.tsx", "purpose": "Total crypto market cap card" },
        { "file": "components/DebtCeilingModal.tsx", "purpose": "Debt ceiling detail modal" }
      ],
      "prop_firm": [
        { "file": "components/PropGuardStatus.tsx", "purpose": "PropGuard drawdown monitoring dashboard for prop firm accounts" }
      ],
      "auth_and_security": [
        { "file": "components/ForgotPassword.tsx", "purpose": "Password reset request form" },
        { "file": "components/ResetPassword.tsx", "purpose": "Password reset with token form" },
        { "file": "components/VerifyEmail.tsx", "purpose": "Email verification handler" },
        { "file": "components/EmailVerificationPending.tsx", "purpose": "Pending email verification state" },
        { "file": "components/MFAEmailVerify.tsx", "purpose": "Email-based MFA code verification" },
        { "file": "components/MFAEncouragement.tsx", "purpose": "Prompt to enable MFA for security" },
        { "file": "components/PasswordStrengthMeter.tsx", "purpose": "Visual password strength indicator" }
      ],
      "account_and_settings": [
        { "file": "components/AccountSwitcher.tsx", "purpose": "Header dropdown for switching accounts" },
        { "file": "components/AccountsManagement.tsx", "purpose": "Account CRUD (CEX/DEX/Prop Firm)" },
        { "file": "components/AddAccountModal.tsx", "purpose": "Add new account with credentials" },
        { "file": "components/AIProvidersManager.tsx", "purpose": "Manage AI provider API keys" },
        { "file": "components/AutoBuySettings.tsx", "purpose": "Configure auto-buy BTC settings" },
        { "file": "components/BlacklistManager.tsx", "purpose": "Coin blacklist with AI review" },
        { "file": "components/PaperTradingManager.tsx", "purpose": "Paper trading mode management" },
        { "file": "components/PaperTradingToggle.tsx", "purpose": "Header toggle for paper trading" },
        { "file": "components/DexConfigSection.tsx", "purpose": "DEX-specific settings configuration" }
      ],
      "layout_and_common": [
        { "file": "components/AboutModal.tsx", "purpose": "App version, changelog, update availability" },
        { "file": "components/CoinIcon.tsx", "purpose": "Crypto coin logo with fallback" },
        { "file": "components/LoadingSpinner.tsx", "purpose": "Animated loading spinner" },
        { "file": "components/Toast.tsx", "purpose": "Toast notifications for order fills and alerts" },
        { "file": "components/RiskDisclaimer.tsx", "purpose": "Terms acceptance modal on first login" },
        { "file": "components/SeasonalityToggle.tsx", "purpose": "Seasonality/market phase display toggle" }
      ],
      "sub_components": {
        "bots": [
          { "file": "components/bots/botUtils.ts", "purpose": "BotFormData type, defaults, parameter validation, pair conversion" }
        ],
        "news": [
          { "file": "components/news/newsUtils.tsx", "purpose": "Lightweight markdown renderer for article content display" }
        ],
        "positions": [
          { "file": "components/positions/AISentimentIcon.tsx", "purpose": "AI sentiment indicator with tooltip" },
          { "file": "components/positions/DealChart.tsx", "purpose": "Buy/sell history visualization within position" },
          { "file": "components/positions/IndicatorModals.tsx", "purpose": "Indicator information modal dialogs" },
          { "file": "components/positions/PriceBar.tsx", "purpose": "Price bar with entry/exit levels" },
          { "file": "components/positions/positionUtils.ts", "purpose": "Position calculation and formatting utilities" }
        ],
        "chart_internals": [
          { "file": "components/LightweightChartModal/hooks/useChartData.ts", "purpose": "Fetch and manage OHLCV data" },
          { "file": "components/LightweightChartModal/hooks/useIndicatorRendering.ts", "purpose": "Render technical indicators on chart" },
          { "file": "components/LightweightChartModal/hooks/useMainChart.ts", "purpose": "Initialize main price chart" },
          { "file": "components/LightweightChartModal/hooks/useOscillators.ts", "purpose": "Manage oscillator sub-charts (RSI, MACD)" },
          { "file": "components/LightweightChartModal/utils/chartMarkers.ts", "purpose": "Entry/exit/TP/SL chart markers" },
          { "file": "components/LightweightChartModal/utils/oscillatorChartFactory.ts", "purpose": "Factory for oscillator charts" },
          { "file": "components/LightweightChartModal/utils/positionLinesRenderer.ts", "purpose": "Position entry/exit lines on chart" }
        ]
      }
    },

    "contexts": [
      { "file": "contexts/AuthContext.tsx", "exports": ["AuthProvider", "useAuth"], "purpose": "User authentication, JWT token management, session state" },
      { "file": "contexts/AccountContext.tsx", "exports": ["AccountProvider", "useAccount"], "purpose": "Multi-account state (CEX/DEX), account switching" },
      { "file": "contexts/BrandContext.tsx", "exports": ["BrandProvider", "useBrand"], "purpose": "White-label branding configuration (app name, logo, colors)" },
      { "file": "contexts/ThemeContext.tsx", "exports": ["ThemeProvider", "useTheme"], "purpose": "Dark/light theme state management" },
      { "file": "contexts/NotificationContext.tsx", "exports": ["NotificationProvider", "useNotifications"], "purpose": "WebSocket order fill notifications, toast alerts, audio" },
      { "file": "contexts/VideoPlayerContext.tsx", "exports": ["VideoPlayerProvider", "useVideoPlayer"], "purpose": "Persistent video player state across page navigation" },
      { "file": "contexts/ArticleReaderContext.tsx", "exports": ["ArticleReaderProvider", "useArticleReader"], "purpose": "Persistent article reader with TTS playback" },
      { "file": "contexts/mediaCoordinator.ts", "exports": ["registerVideoPlayer", "registerArticleReader", "stopVideoPlayer", "stopArticleReader"], "purpose": "Coordinate media playback (pause video when reading, vice versa)" }
    ],

    "hooks": {
      "global": [
        { "file": "hooks/useAudio.ts", "purpose": "Web Audio API for order fill notification sounds" },
        { "file": "hooks/useMarketSeason.ts", "purpose": "Fetch market indicators and determine current season" }
      ],
      "page_specific": {
        "bots": [
          { "file": "pages/bots/hooks/useBotMutations.ts", "purpose": "Create/update/delete/start/stop bot mutations" },
          { "file": "pages/bots/hooks/useBotsData.ts", "purpose": "Fetch bots, strategies, trading pairs, portfolio" },
          { "file": "pages/bots/hooks/useValidation.ts", "purpose": "Bot config validation, budget sizing, parameters" }
        ],
        "charts": [
          { "file": "pages/charts/hooks/useChartManagement.ts", "purpose": "Chart instance initialization and lifecycle" },
          { "file": "pages/charts/hooks/useChartsData.ts", "purpose": "Fetch OHLCV data for multiple pairs/timeframes" },
          { "file": "pages/charts/hooks/useIndicators.ts", "purpose": "Indicator state, rendering, and settings" }
        ],
        "positions": [
          { "file": "pages/positions/hooks/usePositionFilters.ts", "purpose": "Filter and search positions" },
          { "file": "pages/positions/hooks/usePositionMutations.ts", "purpose": "Close, add funds, update settings, save notes" },
          { "file": "pages/positions/hooks/usePositionTrades.ts", "purpose": "Fetch and cache trades for positions" },
          { "file": "pages/positions/hooks/usePositionsData.ts", "purpose": "Fetch positions, bots, prices, calculate P&L" }
        ],
        "news": [
          { "file": "pages/news/hooks/useArticleContent.ts", "purpose": "Fetch and cache article content by URL" },
          { "file": "pages/news/hooks/useNewsData.ts", "purpose": "Fetch news and video articles with caching" },
          { "file": "pages/news/hooks/useNewsFilters.ts", "purpose": "Filter news by source, date, category" },
          { "file": "pages/news/hooks/useTTSSync.ts", "purpose": "Text-to-speech with word timing, voice cycling, rate control" },
          { "file": "pages/news/hooks/useSeenStatus.ts", "purpose": "Track and query user seen/unseen status for content" }
        ]
      }
    },

    "api_layer": {
      "base_url": "Configured via VITE_API_URL env var, defaults to same origin",
      "auth": "Authorization: Bearer {token} header via Axios interceptor",
      "file": "services/api.ts",
      "modules": [
        { "name": "authFetch", "purpose": "Fetch wrapper with auth token injection" },
        { "name": "dashboardApi", "purpose": "Dashboard statistics" },
        { "name": "positionsApi", "purpose": "Position CRUD, trades, AI logs, settings, budget resize" },
        { "name": "tradesApi", "purpose": "All trades" },
        { "name": "signalsApi", "purpose": "Trading signals" },
        { "name": "marketDataApi", "purpose": "Market data, coin listings" },
        { "name": "settingsApi", "purpose": "Get/update settings by key" },
        { "name": "monitorApi", "purpose": "Start/stop trading monitor" },
        { "name": "accountApi", "purpose": "Balances, aggregate value, portfolio conversion" },
        { "name": "statusApi", "purpose": "API connection and monitor status" },
        { "name": "botsApi", "purpose": "Bot CRUD, strategies, logs, decisions, scanners, indicators, bulk ops" },
        { "name": "templatesApi", "purpose": "Bot template management" },
        { "name": "orderHistoryApi", "purpose": "Order history with filtering and pagination" },
        { "name": "blacklistApi", "purpose": "Blacklist and category management with AI review" },
        { "name": "aiCredentialsApi", "purpose": "AI provider credential management" },
        { "name": "autoBuyApi", "purpose": "Auto-buy BTC settings" },
        { "name": "accountValueApi", "purpose": "Historical account value snapshots" }
      ]
    },

    "state_management": {
      "pattern": "React Context (app state) + React Query (server state)",
      "contexts": ["AuthContext", "AccountContext", "BrandContext", "ThemeContext", "NotificationContext", "VideoPlayerContext", "ArticleReaderContext"],
      "react_query": {
        "purpose": "Centralized data caching with automatic refetch",
        "polling_intervals": {
          "positions": "30 seconds",
          "portfolio_prices": "2 minutes",
          "btc_eth_prices": "1 minute",
          "closed_position_badges": "60 seconds"
        }
      }
    },

    "realtime": {
      "websocket": {
        "endpoint": "/ws/notifications",
        "events": ["base_order", "dca_order", "sell_order", "partial_fill"],
        "limits": {
          "max_connections_per_user": 5,
          "max_message_size_bytes": 4096,
          "idle_timeout_seconds": 300
        },
        "features": ["Audio notifications", "Toast alerts", "Auto-reconnect with exponential backoff"]
      }
    },

    "types": {
      "file": "types/index.ts",
      "categories": {
        "position": ["Position", "LimitOrderDetails", "LimitOrderFill", "Trade", "Signal", "AIBotLog"],
        "bot": ["Bot", "BotCreate", "BotStats", "StrategyParameter", "StrategyDefinition", "OrderHistory"],
        "account": ["Balances", "AggregateValue", "DashboardStats", "Settings"],
        "market": ["Candle", "ReservedBalances", "MarketData"],
        "perps": ["PerpsProduct", "PerpsPosition", "PerpsPortfolio"],
        "sentiment": ["FearGreedData", "BTCDominanceResponse", "AltseasonIndexResponse", "ATHResponse", "BTCRSIResponse", "HalvingCountdown", "DebtCeilingEvent"]
      }
    },

    "utilities": [
      { "file": "utils/dateFormat.ts", "purpose": "Date/time formatting helpers" },
      { "file": "utils/marketSentiment.ts", "purpose": "Fear & Greed coloring, debt calculations, halving countdown" },
      { "file": "utils/seasonDetection.ts", "purpose": "Client-side market season detection logic" },
      { "file": "utils/indicators/calculations.ts", "purpose": "MACD, RSI, Bollinger Bands, EMA, SMA calculations" },
      { "file": "utils/indicators/definitions.ts", "purpose": "Indicator metadata and default settings" },
      { "file": "utils/indicators/types.ts", "purpose": "Indicator type definitions (CandleData, IndicatorResult)" },
      { "file": "config/api.ts", "purpose": "API base URL configuration from env vars" },
      { "file": "constants/voices.ts", "purpose": "TTS voice IDs and cycling configuration" }
    ]
  },

  "data_flow": {
    "request_flow": "React Page -> Custom Hook -> API Module (Axios) -> FastAPI Router -> Service/Engine -> SQLAlchemy Model -> SQLite",
    "trading_flow": "MultiBotMonitor -> TradingStrategy.check_signals() -> TradingEngineV2.process_signal() -> TradingClient -> ExchangeClient (-> PropGuard for prop firms) -> Exchange API",
    "websocket_flow": "Exchange order fill -> WebSocketManager.broadcast(user_id) -> NotificationContext -> Toast component + Audio notification",
    "ai_decision_flow": "MultiBotMonitor -> AIService.get_recommendation() -> AI Provider API -> TradingEngine -> OrderValidation -> Exchange",
    "background_task_flow": "FastAPI startup -> asyncio.create_task() -> Periodic loop with sleep interval -> Database operations"
  },

  "multi_user_data_isolation": {
    "description": "All user-facing API endpoints scope queries by current_user.id or their account IDs. Background services process all users intentionally but with per-account isolation.",
    "ownership_chain": "User -> Account(s) -> Bot(s) -> Position(s) -> Trade(s)",
    "patterns": {
      "router_queries": "Filter by user_account_ids: select(Account.id).where(Account.user_id == current_user.id), then Position.account_id.in_(user_account_ids)",
      "position_ownership": "Helper function _get_user_position() in position_limit_orders_router.py verifies position belongs to user's accounts before any operation",
      "bot_ownership": "All bot queries include Bot.user_id == current_user.id; bot names are unique per-user via composite constraint uq_bot_user_name(user_id, name)",
      "websocket_scoping": "WebSocketManager stores (websocket, user_id) tuples; broadcast() filters by user_id so notifications only reach the owning user",
      "exchange_clients": "Each account has its own API credentials; get_exchange_client_for_account(db, account_id) creates per-account clients with async locking",
      "paper_trading": "Users without Coinbase credentials get PublicMarketDataClient (no-auth public endpoints) instead of failing CoinbaseClient"
    },
    "background_services": "Bot monitor, limit order monitor, and reconciliation services intentionally process all users (no user filter) but use per-account exchange clients and route notifications to the correct user",
    "hardened_in_v2_7_0": "Round 1: order_history user scoping, perps position ownership checks, scanner logs user filter, signals user scoping, news cleanup auth, account balance ownership, bot name per-user uniqueness, delisted pair monitor account selection",
    "hardened_in_v2_7_1": "Round 2: settings/seasonality/blacklist admin-gated, source ownership with user_id, template seed-defaults auth, strategy endpoints auth, position active count scoped, perps monitor broadcast scoped, AI service per-user credentials + Gemini race fix",
    "hardened_in_v2_7_2": "Round 3: balance cache isolation (account_id passed to all get_accounts/get_btc_balance calls), per-instance rate limiter (no cross-user throttling), bull_flag_scanner BlacklistedCoin scoped to user, broadcast_position_update crash fix in sell/buy executors, factory account_id passthrough",
    "hardened_in_v2_7_3": "Round 4: conversion-status endpoint auth, dead calculate_available_balance removed, OrderReconciliationMonitor+MissingOrderDetector scoped by account_id, ByBit per-instance rate limiter, monitor/shutdown/pair-sync endpoints admin-gated, market_data prefers system/public credentials, dead order_monitor.py + limit_order_monitor dead methods removed, TTS endpoints auth, changelog auth, DEX portfolio price lookup scoped to same user",
    "scalability_v2_26_0": "Parallel bot processing (Semaphore(5) + contextvars), exchange client cache locking, candle cache shared across users, single-flight thundering herd prevention, rate limiter pruning",
    "security_audit_v2_26_2": "Internet-facing hardening: login timing equalization (constant-time bcrypt), MFA brute-force rate limiting (5 attempts/5min per token), nginx rate limiting (auth 5r/m + API 30r/s per IP), HSTS + CSP security headers, request size limit (10MB), per-username + per-IP login rate limiting, per-email forgot-password rate limiting, page_size clamped to 200 max, settings endpoint superuser-gated, article flagging superuser-gated, per-user article fetch rate limit (30/hr), WebSocket idle timeout 86400s300s",
    "security_audit_v2_26_3": "Token revocation (JTI-based revoked_tokens table + tokens_valid_after bulk invalidation on password change/reset), WebSocket per-user connection limit (5), message size limit (4KB), image endpoint path traversal guard (is_relative_to), CSP media-src blob: for TTS audio"
  }
}
